var express = require("express");
var php = require("node-php");
var _ = require('underscore');
//var util = require("util");

var Server = function(){
  var running = null;
  var app = null
  this.name = '';

  this.setApplication = function(options){
    var defOps = {
      SERVER: "localhost",
      DIR: "./application",
      START: "/",
      PORT: "8080"
    }
    var op = _.extend(defOps,options);
    this.name = op.DIR.replace(/[^a-zA-z]\//,'');
    app = new Application(op);
  }

  this.start = function(name,callback){
    if(name == this.name){
      app.start(function(err,url){
        if(!err){
          running = name;
        }
        callback(err,url);
      });
    }else{
      callback({message:"No such application"});
    }
  }
};

var Application = function(options){
  var self = this;
  var options = options;
  var app = express();
  app.use(express.static(options.DIR));
  app.all(options.START,php.cgi(options.DIR));
  this.running = false;

  this.getURL = function() {
    return "http://" + options.SERVER + ":" + options.PORT + options.START
  };

  this.start = function(callback){
    if(this.running){
      console.log("server:" + options.DIR + " already running call stop() first");
      if(typeof callback != 'undefined'){
        callback({message:"Application already running"});
      }
    }else{
      app.listen(options.PORT.toString(),function(){
        self.running = true;
        if(typeof callback != 'undefined'){
          callback(null,self.getURL());
        }
      });
    }
  }

  this.getOptions = function(){
    return options;
  }
}

module.exports = Server;